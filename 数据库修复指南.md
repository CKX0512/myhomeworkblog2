# æ•°æ®åº“ä¿®å¤æŒ‡å—

## ğŸ” é—®é¢˜è¯Šæ–­

æ ¹æ®ä½ é‡åˆ°çš„é—®é¢˜ï¼ˆå‘æ–‡ç« å¾ˆæ…¢/å‘ä¸äº†ï¼Œé¦–é¡µä¸€ç›´åŠ è½½ï¼‰ï¼Œå¾ˆå¯èƒ½æ˜¯ **RLS (Row Level Security) ç­–ç•¥**çš„é—®é¢˜ã€‚

## ğŸ› ï¸ ä¿®å¤æ­¥éª¤

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ SQL è„šæœ¬ï¼ˆæ¨èï¼‰

1. **ç™»å½• Supabase Dashboard**
   - è®¿é—® [Supabase Dashboard](https://app.supabase.com)
   - é€‰æ‹©ä½ çš„é¡¹ç›®ï¼š`my-homework-blog-2`

2. **æ‰“å¼€ SQL Editor**
   - åœ¨å·¦ä¾§èœå•ä¸­æ‰¾åˆ° **SQL Editor**
   - ç‚¹å‡» **New query**

3. **è¿è¡Œä¿®å¤è„šæœ¬**
   - å¤åˆ¶ `fix_database_rls.sql` æ–‡ä»¶ä¸­çš„å…¨éƒ¨å†…å®¹
   - ç²˜è´´åˆ° SQL Editor ä¸­
   - ç‚¹å‡» **Run** æˆ–æŒ‰ `Ctrl+Enter` (Windows) / `Cmd+Enter` (Mac)

4. **éªŒè¯ä¿®å¤**
   - è„šæœ¬è¿è¡Œå®Œæˆåï¼Œåº”è¯¥çœ‹åˆ° "Success. No rows returned"
   - å¦‚æœçœ‹åˆ°é”™è¯¯ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨é…ç½® RLS ç­–ç•¥

å¦‚æœ SQL è„šæœ¬æ— æ³•è¿è¡Œï¼Œå¯ä»¥æ‰‹åŠ¨é…ç½®ï¼š

#### 1. æ£€æŸ¥ RLS æ˜¯å¦å¯ç”¨

1. è¿›å…¥ **Database** â†’ **Tables**
2. ç‚¹å‡» `posts` è¡¨
3. æŸ¥çœ‹ **Policies** æ ‡ç­¾é¡µ
4. å¦‚æœçœ‹åˆ° "RLS is disabled"ï¼Œç‚¹å‡» **Enable RLS**

#### 2. ä¸º posts è¡¨æ·»åŠ ç­–ç•¥

1. åœ¨ `posts` è¡¨çš„ **Policies** æ ‡ç­¾é¡µ
2. ç‚¹å‡» **New Policy**
3. é€‰æ‹© **For full customization**
4. æ·»åŠ ä»¥ä¸‹ç­–ç•¥ï¼š

**ç­–ç•¥ 1ï¼šå…è®¸æ‰€æœ‰äººè¯»å–**
- Policy name: `Allow public read posts`
- Allowed operation: `SELECT`
- USING expression: `true`

**ç­–ç•¥ 2ï¼šå…è®¸å·²è®¤è¯ç”¨æˆ·æ’å…¥**
- Policy name: `Allow authenticated insert posts`
- Allowed operation: `INSERT`
- WITH CHECK expression: `auth.role() = 'authenticated'`

**ç­–ç•¥ 3ï¼šå…è®¸ä½œè€…æ›´æ–°è‡ªå·±çš„æ–‡ç« **
- Policy name: `Allow author update own posts`
- Allowed operation: `UPDATE`
- USING expression: `auth.uid() = author_id`
- WITH CHECK expression: `auth.uid() = author_id`

**ç­–ç•¥ 4ï¼šå…è®¸ä½œè€…åˆ é™¤è‡ªå·±çš„æ–‡ç« **
- Policy name: `Allow author delete own posts`
- Allowed operation: `DELETE`
- USING expression: `auth.uid() = author_id`

#### 3. ä¸º users è¡¨æ·»åŠ ç­–ç•¥

1. åœ¨ `users` è¡¨çš„ **Policies** æ ‡ç­¾é¡µ
2. æ·»åŠ ä»¥ä¸‹ç­–ç•¥ï¼š

**ç­–ç•¥ 1ï¼šå…è®¸æ‰€æœ‰äººè¯»å–**
- Policy name: `Allow public read users`
- Allowed operation: `SELECT`
- USING expression: `true`

**ç­–ç•¥ 2ï¼šå…è®¸å·²è®¤è¯ç”¨æˆ·æ’å…¥**
- Policy name: `Allow authenticated insert users`
- Allowed operation: `INSERT`
- WITH CHECK expression: `auth.uid() = id`

**ç­–ç•¥ 3ï¼šå…è®¸ç”¨æˆ·æ›´æ–°è‡ªå·±çš„ä¿¡æ¯**
- Policy name: `Allow user update own profile`
- Allowed operation: `UPDATE`
- USING expression: `auth.uid() = id`
- WITH CHECK expression: `auth.uid() = id`

#### 4. ä¸º comments è¡¨æ·»åŠ ç­–ç•¥

1. åœ¨ `comments` è¡¨çš„ **Policies** æ ‡ç­¾é¡µ
2. æ·»åŠ ä»¥ä¸‹ç­–ç•¥ï¼š

**ç­–ç•¥ 1ï¼šå…è®¸æ‰€æœ‰äººè¯»å–**
- Policy name: `Allow public read comments`
- Allowed operation: `SELECT`
- USING expression: `true`

**ç­–ç•¥ 2ï¼šå…è®¸å·²è®¤è¯ç”¨æˆ·æ’å…¥**
- Policy name: `Allow authenticated insert comments`
- Allowed operation: `INSERT`
- WITH CHECK expression: `auth.role() = 'authenticated'`

## âœ… éªŒè¯ä¿®å¤

ä¿®å¤å®Œæˆåï¼Œæµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **æµ‹è¯•é¦–é¡µåŠ è½½**
   - åˆ·æ–°é¦–é¡µ
   - åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºæ–‡ç« åˆ—è¡¨ï¼ˆå¦‚æœæœ‰æ–‡ç« ï¼‰
   - å¦‚æœæ²¡æœ‰æ–‡ç« ï¼Œåº”è¯¥æ˜¾ç¤º"è¿˜æ²¡æœ‰æ–‡ç« "çš„æç¤º

2. **æµ‹è¯•å‘æ–‡ç« **
   - ç™»å½•è´¦å·
   - ç‚¹å‡»"å†™æ–‡ç« "
   - å¡«å†™æ ‡é¢˜å’Œå†…å®¹
   - ç‚¹å‡»"å‘å¸ƒæ–‡ç« "
   - åº”è¯¥èƒ½æˆåŠŸå‘å¸ƒå¹¶è·³è½¬åˆ°æ–‡ç« è¯¦æƒ…é¡µ

3. **æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°**
   - æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
   - æŸ¥çœ‹ **Console** æ ‡ç­¾é¡µ
   - ä¸åº”è¯¥æœ‰çº¢è‰²é”™è¯¯ä¿¡æ¯
   - å¦‚æœæœ‰é”™è¯¯ï¼Œè¯·è®°å½•é”™è¯¯ä¿¡æ¯

## ğŸ”§ å¦‚æœä»ç„¶æœ‰é—®é¢˜

### æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„

ç¡®ä¿è¡¨ç»“æ„æ­£ç¡®ï¼š

1. **posts è¡¨åº”è¯¥æœ‰ä»¥ä¸‹å­—æ®µï¼š**
   - `id` (uuid, primary key)
   - `title` (text)
   - `content` (text)
   - `author_id` (uuid, å…³è” auth.users.id)
   - `created_at` (timestamptz)
   - `updated_at` (timestamptz)

2. **users è¡¨åº”è¯¥æœ‰ä»¥ä¸‹å­—æ®µï¼š**
   - `id` (uuid, primary key, å…³è” auth.users.id)
   - `username` (text)
   - `email` (text, å¯é€‰)
   - `created_at` (timestamptz)
   - `updated_at` (timestamptz)

3. **comments è¡¨åº”è¯¥æœ‰ä»¥ä¸‹å­—æ®µï¼š**
   - `id` (uuid, primary key)
   - `post_id` (uuid, å…³è” posts.id)
   - `user_id` (uuid, å…³è” auth.users.id, å¯é€‰)
   - `content` (text)
   - `created_at` (timestamptz)
   - `updated_at` (timestamptz)

### æ£€æŸ¥å¤–é”®çº¦æŸ

å¦‚æœ `posts.author_id` æœ‰å¤–é”®çº¦æŸæŒ‡å‘ `users.id`ï¼Œä½† `users` è¡¨ä¸­æ²¡æœ‰å¯¹åº”çš„è®°å½•ï¼Œæ’å…¥ä¼šå¤±è´¥ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®ä¿æ³¨å†Œæ—¶åœ¨ `users` è¡¨ä¸­åˆ›å»ºäº†è®°å½•
- æˆ–è€…ç§»é™¤å¤–é”®çº¦æŸï¼ˆå¦‚æœä¸éœ€è¦ï¼‰

### æŸ¥çœ‹ Supabase æ—¥å¿—

1. è¿›å…¥ **Logs** â†’ **Postgres Logs**
2. æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
3. ç‰¹åˆ«å…³æ³¨æƒé™ç›¸å…³çš„é”™è¯¯

## ğŸ“ å¸¸è§é”™è¯¯

### é”™è¯¯ 1: "new row violates row-level security policy"

**åŸå› ï¼š** RLS ç­–ç•¥é˜»æ­¢äº†æ’å…¥æ“ä½œ

**è§£å†³ï¼š** è¿è¡Œ `fix_database_rls.sql` è„šæœ¬

### é”™è¯¯ 2: "permission denied for table posts"

**åŸå› ï¼š** æ²¡æœ‰æ­£ç¡®çš„ SELECT/INSERT ç­–ç•¥

**è§£å†³ï¼š** ç¡®ä¿å·²æ·»åŠ "Allow public read"å’Œ"Allow authenticated insert"ç­–ç•¥

### é”™è¯¯ 3: "foreign key constraint fails"

**åŸå› ï¼š** `posts.author_id` å¼•ç”¨çš„ `users.id` ä¸å­˜åœ¨

**è§£å†³ï¼š** ç¡®ä¿æ³¨å†Œæ—¶åœ¨ `users` è¡¨ä¸­åˆ›å»ºäº†è®°å½•

## ğŸ¯ å¿«é€Ÿæ£€æŸ¥æ¸…å•

- [ ] RLS å·²å¯ç”¨ï¼ˆposts, users, comments è¡¨ï¼‰
- [ ] posts è¡¨æœ‰ SELECT ç­–ç•¥ï¼ˆå…è®¸æ‰€æœ‰äººè¯»å–ï¼‰
- [ ] posts è¡¨æœ‰ INSERT ç­–ç•¥ï¼ˆå…è®¸å·²è®¤è¯ç”¨æˆ·æ’å…¥ï¼‰
- [ ] users è¡¨æœ‰ SELECT ç­–ç•¥ï¼ˆå…è®¸æ‰€æœ‰äººè¯»å–ï¼‰
- [ ] users è¡¨æœ‰ INSERT ç­–ç•¥ï¼ˆå…è®¸å·²è®¤è¯ç”¨æˆ·æ’å…¥ï¼‰
- [ ] comments è¡¨æœ‰ SELECT ç­–ç•¥ï¼ˆå…è®¸æ‰€æœ‰äººè¯»å–ï¼‰
- [ ] comments è¡¨æœ‰ INSERT ç­–ç•¥ï¼ˆå…è®¸å·²è®¤è¯ç”¨æˆ·æ’å…¥ï¼‰
- [ ] æµ‹è¯•é¦–é¡µå¯ä»¥æ­£å¸¸åŠ è½½
- [ ] æµ‹è¯•å‘æ–‡ç« åŠŸèƒ½æ­£å¸¸
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ²¡æœ‰é”™è¯¯

---

**ä¿®å¤å®Œæˆåï¼Œè®°å¾—æµ‹è¯•æ‰€æœ‰åŠŸèƒ½ï¼Œç¡®ä¿ä¸€åˆ‡æ­£å¸¸ï¼** âœ…

